#! /bin/bash

# 1675210948 1675210948_20250521_161644
# 1675623808 1675623808_20250521_161644
# 1675632179 1675632179_20250521_161644
# 1675643846 1675643846_20250521_161643
# 1676313206 1676313206_20250520_161045
# 1678295187 1678295187_20250520_161045
# 1678743988 1678743988_20250520_161045
# 1682448988 1682448988_20250520_161045
# 1677020482 1677020482_20250521_161644
# 1678122565 1678122565_20250521_161644
# 1689176790 1689176790_20250521_161644
# 1676657789 1676657789_20250521_161644
# 1677777992 1677777992_20250521_161644
# 1679247986 1679247986_20250521_161644
# 1680626188 1680626188_20250521_161644
# 1688399183 1688399183_20250521_161644
# 1677002481 1677002481_20250521_161644
# 1677183387 1677183387_20250521_161644
# 1677011008 1677011008_20250521_102107
# 1681143685 1681143685_20250521_161644
# 1683492604 1683492604_20250521_161644
# 1681920680 1681920680_20250521_161644
# 1680798562 1680798562_20250521_161644
# 1677195529 1677195529_20250521_161644
# 1684087370 1684087370_20250521_161644
# 1678726283 1678726283_20250528_164604
# 1678734987 1678734987_20250528_164637
# 1689003684 1689003684_20250528_164713
# 1685641589 1685641589_20250521_161644
# 1678467685 1678467685_20250521_161644
# 1679605292 1679605292_20250521_161644
# 1677174749 1677174749_20250521_161644
# 1678381591 1678381591_20250521_161644
# 1675021905 1675021905_20250521_161644
# 1677795989 1677795989_20250521_161644
# 1678899080 1678899080_20250528_164637
# 1675816512 1675816512_20250521_161644
# 1679419886 1679419886_20250521_161644
# 1689090392 1689090392_20250528_164637
# 1684781618 1684781618_20250521_161645
# 1679615321 1679615321_20250521_161644
# 1679333668 1679333668_20250521_161644
# 1680644082 1680644082_20250521_161644
# 1681229848 1681229848_20250521_161644

# BOX 13: 1750887085 1753129121 1753559424 1753730543 1754679689 1755196048 1755369199 1756059088

# 定义 fname 列表
fname=$1

input_file="20251015_090000"
file_timestamp="20251015_090000"
# file_timestamp=$(date +"%Y%m%d_%H%M%S")
output_dir="/scratch3/users/liutianyang/katcali_pipeline/level2/py_results/${file_timestamp}"
logs_dir="/scratch3/users/liutianyang/katcali_pipeline/level2/logs/${file_timestamp}"
mkdir -p ${output_dir}
mkdir -p ${logs_dir}

# MaxMem: 
# fname 循环
# for fname in "${fnames[@]}"; do

# ant 从 m000 到 m063 循环
for i in {000..063}; do
    ant="m${i}"

    # pol 循环
    for pol in v h; do 

        echo "${fname} ${ant} ${pol}"

        script_name="level2_${fname}_${ant}_${pol}"
        echo "#! /bin/bash
#SBATCH --cpus-per-task=1
#SBATCH --mem-per-cpu=14GB
#SBATCH --time=48:00:00
#SBATCH --error=${logs_dir}/job_${fname}_${ant}${pol}_%J.err
#SBATCH --output=${logs_dir}/job_${fname}_${ant}${pol}_%J.out
#SBATCH --exclude=compute-103

export SINGULARITY_SHELL=/bin/bash" > ${script_name}

        echo "singularity exec /data/exp_soft/containers/katcal.sif python3 ./KATcali_UHF_level2.py ${fname} ${ant} ${pol} ${input_file} ${output_dir}" >> ${script_name}
        # echo "singularity exec /data/exp_soft/containers/katcal.sif python3 ./tmp/KATcali_UHF_level2.py ${fname} ${ant} ${pol} ${input_file} ${output_dir}" >> ${script_name}

        sbatch ${script_name}

        rm -f ${script_name}

    done
done
# done
